<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ALTA Auto Insurance Calculator</title>
  <style>
    :root{
      --bg:#ffffff;
      --panel:#ffffff;
      --muted:#4b5563;          /* gray-600 */
      --text:#111827;           /* gray-900 */
      --accent:#2563eb;         /* blue-600 */
      --accent2:#1d4ed8;        /* blue-700 */
      --danger:#b91c1c;         /* red-700 */
      --ring:rgba(37,99,235,.25);
      --border:rgba(17,24,39,.12);
      --shadow:0 10px 30px rgba(17,24,39,.10);
      --shadow2:0 24px 80px rgba(17,24,39,.18);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu;
      background: var(--bg);
      color: var(--text);
      min-height:100svh;
      padding: 24px;
    }

    /* Page button */
    .page-wrap{ max-width: 980px; margin: 0 auto; }
    h1{ margin:0 0 6px; font-size: 1.8rem; }
    p{ margin:0 0 16px; color: var(--muted); line-height:1.4; }
    .open-btn{
      appearance:none; border:0; cursor:pointer;
      padding: 12px 16px;
      border-radius: 12px;
      font-weight: 800;
      color: #fff;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      box-shadow: 0 10px 24px rgba(37,99,235,.18);
    }
    .open-btn:focus{ outline:none; box-shadow: 0 0 0 4px var(--ring), 0 10px 24px rgba(37,99,235,.18); }

    /* ------------------ MODAL ------------------ */
    .modal-overlay{
      position: fixed;
      inset: 0;
      background: rgba(17,24,39,.55);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 999;
    }
    .modal-overlay.open{ display:flex; }

    .modal{
      width: min(1100px, 100%);
      max-height: min(92svh, 920px);
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 18px;
      box-shadow: var(--shadow2);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .modal-header{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 12px;
      padding: 14px 16px;
      border-bottom: 1px solid var(--border);
      background: #fafafa;
    }
    .modal-title{
      margin:0;
      font-size: 1.1rem;
      font-weight: 900;
      letter-spacing: .2px;
    }
    .modal-subtitle{
      margin: 2px 0 0;
      font-size: .9rem;
      color: var(--muted);
    }

    .close-btn{
      appearance:none;
      border: 1px solid rgba(17,24,39,.18);
      background: #fff;
      width: 40px;
      height: 40px;
      border-radius: 12px;
      cursor:pointer;
      font-size: 18px;
      line-height: 1;
      font-weight: 900;
      color: var(--text);
    }
    .close-btn:focus{ outline:none; box-shadow: 0 0 0 4px var(--ring); }

    .modal-body{
      padding: 16px;
      overflow: auto; /* scroll inside modal */
    }

    /* Calculator layout inside modal */
    .grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 16px;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
    }

    .panel{
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panel .topbar{
      padding: 14px 16px;
      border-bottom: 1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 12px;
      background: #fafafa;
    }
    .panel .topbar .title{
      font-weight: 900;
      color: var(--text);
    }
    .panel .content{ padding: 16px; }

    .section{
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 14px;
      margin-bottom: 14px;
    }
    .section h3{
      margin:0 0 10px;
      font-size: 1rem;
      font-weight: 900;
      color: var(--text);
      display:flex;
      justify-content: space-between;
      align-items:center;
      gap: 10px;
    }

    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 620px){
      .row{ grid-template-columns: 1fr; }
    }

    label{
      display:block;
      font-size: .92rem;
      margin: 0 0 6px;
      color: var(--text);
      font-weight: 650;
    }

    input, select{
      width:100%;
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid rgba(17,24,39,.18);
      background: #fff;
      color: var(--text);
      outline:none;
      font-size: 1rem;
    }
    input:focus, select:focus{
      border-color: rgba(37,99,235,.65);
      box-shadow: 0 0 0 4px var(--ring);
    }

    .hint{ color: var(--muted); font-size: .85rem; margin-top: 6px; }
    .error{ color: var(--danger); margin-top: 8px; min-height: 1.2rem; font-size: .9rem; }

    .actions{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    .btn{
      appearance:none;
      border:0;
      padding: 11px 14px;
      border-radius: 12px;
      cursor:pointer;
      font-weight: 900;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      color:#fff;
      box-shadow: 0 8px 20px rgba(37,99,235,.18);
    }
    .btn.secondary{
      background:#fff;
      border: 1px solid rgba(17,24,39,.18);
      box-shadow:none;
      color: var(--text);
    }

    .pill{
      display:inline-block;
      padding: 6px 10px;
      border-radius: 999px;
      background: #f3f4f6;
      border: 1px solid rgba(17,24,39,.12);
      color: var(--text);
      font-size: .82rem;
      margin: 4px 6px 0 0;
    }

    .price{
      font-size: 2.1rem;
      font-weight: 950;
      margin: 6px 0;
      color: var(--text);
      letter-spacing: -.2px;
    }
    .muted{ color: var(--muted); }
    .small{ font-size: .85rem; color: var(--muted); }

    ul{ margin:.5rem 0 0 1.1rem; padding:0; }
    li{ margin:.25rem 0; color: var(--text); }
    .divider{ height:1px; background: rgba(17,24,39,.10); margin: 10px 0; }

    .toggle{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
      font-size:.9rem;
      color: var(--text);
      user-select: none;
    }
    .toggle input{ width:auto; }
    .note{
      font-size:.85rem;
      color: var(--muted);
      margin-top: 8px;
      line-height: 1.35;
    }
  </style>
</head>

<body>
  <div class="page-wrap">
    <h1>Auto Insurance Calculator</h1>
    <p>Click the button to open the calculator in a modal popup. Results update automatically as you edit fields.</p>
    <button class="open-btn" id="openModalBtn">Open Calculator</button>
  </div>

  <!-- Modal Overlay -->
  <div class="modal-overlay" id="modalOverlay" aria-hidden="true">
    <!-- Modal -->
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle" aria-describedby="modalDesc">
      <div class="modal-header">
        <div>
          <div class="modal-title" id="modalTitle">Auto Insurance Calculator</div>
          <div class="modal-subtitle" id="modalDesc">All questions on one screen • Live results • Demo estimator</div>
        </div>
        <button class="close-btn" id="closeModalBtn" aria-label="Close modal">×</button>
      </div>

      <div class="modal-body">
        <div class="grid">

          <!-- FORM PANEL -->
          <section class="panel">
            <div class="topbar">
              <div class="title">Rate Factors</div>
              <div class="toggle" title="Gender-based rating may be restricted by jurisdiction">
                <input id="enableGender" type="checkbox" />
                <label for="enableGender" style="margin:0;">Enable gender rating (demo)</label>
              </div>
            </div>
            <div class="content">
              <form id="rateForm" novalidate>

                <div class="section">
                  <h3>Driver</h3>
                  <div class="row">
                    <div>
                      <label for="age">Driver Age</label>
                      <input id="age" type="number" min="16" max="100" value="30" />
                      <div class="hint">16–100</div>
                    </div>
                    <div>
                      <label for="gender">Gender</label>
                      <select id="gender">
                        <option value="notsay" selected>Prefer not to say</option>
                        <option value="female">Female</option>
                        <option value="male">Male</option>
                      </select>
                      <div class="hint">Ignored unless gender rating is enabled.</div>
                    </div>
                  </div>

                  <div class="row" style="margin-top:12px;">
                    <div>
                      <label for="occupation">Occupation</label>
                      <select id="occupation">
                        <option value="tech" selected>Technology / Engineering</option>
                        <option value="professional">Professional / Managerial</option>
                        <option value="healthcare">Healthcare</option>
                        <option value="education">Education</option>
                        <option value="government">Government</option>
                        <option value="military">Military</option>
                        <option value="service">Service / Trades</option>
                        <option value="student">Student</option>
                        <option value="retired">Retired</option>
                        <option value="unemployed">Unemployed</option>
                        <option value="other">Other</option>
                      </select>
                    </div>
                    <div>
                      <label for="credit">Credit Score</label>
                      <input id="credit" type="number" min="300" max="850" value="720" />
                      <div class="hint">300–850</div>
                    </div>
                  </div>
                </div>

                <div class="section">
                  <h3>Vehicles & Usage</h3>
                  <div class="row">
                    <div>
                      <label for="vehicles"># of Vehicles</label>
                      <input id="vehicles" type="number" min="1" max="10" value="2" />
                    </div>
                    <div>
                      <label for="accidents">At‑fault Accidents (last 3 years)</label>
                      <input id="accidents" type="number" min="0" max="10" value="0" />
                    </div>
                  </div>

                  <div class="row" style="margin-top:12px;">
                    <div>
                      <label for="vehicleType">Vehicle Type</label>
                      <select id="vehicleType">
                        <option value="sedan" selected>Sedan / Coupe</option>
                        <option value="suv">SUV / Crossover</option>
                        <option value="truck">Pickup Truck</option>
                        <option value="minivan">Minivan</option>
                        <option value="sports">Sports / Performance</option>
                        <option value="luxury">Luxury</option>
                        <option value="ev">Electric (EV)</option>
                      </select>
                    </div>
                    <div>
                      <label for="coverageType">Coverage Type</label>
                      <select id="coverageType">
                        <option value="liability">Liability Only (State Minimum)</option>
                        <option value="standard" selected>Standard Full Coverage</option>
                        <option value="enhanced">Enhanced Full Coverage</option>
                      </select>
                    </div>
                  </div>

                  <div class="row" style="margin-top:12px;">
                    <div>
                      <label for="mileage">Annual Mileage</label>
                      <input id="mileage" type="number" min="0" max="100000" value="12000" />
                      <div class="hint">Typical: 7,500–15,000 miles/year</div>
                    </div>
                    <div>
                      <label for="state">Garage State</label>
                      <select id="state">
                        <option value="TX" selected>Texas</option>
                        <option value="CA">California</option>
                        <option value="FL">Florida</option>
                        <option value="NY">New York</option>
                        <option value="NJ">New Jersey</option>
                        <option value="LA">Louisiana</option>
                        <option value="MI">Michigan</option>
                        <option value="CO">Colorado</option>
                        <option value="GA">Georgia</option>
                        <option value="IL">Illinois</option>
                        <option value="WA">Washington</option>
                        <option value="PA">Pennsylvania</option>
                        <option value="OH">Ohio</option>
                        <option value="AZ">Arizona</option>
                        <option value="VA">Virginia</option>
                        <option value="MA">Massachusetts</option>
                        <option value="CT">Connecticut</option>
                        <option value="OTHER">Other</option>
                      </select>
                      <div class="hint">Demo uses coarse state factors.</div>
                    </div>
                  </div>
                </div>

                <div class="section">
                  <h3>Discounts</h3>
                  <div class="row">
                    <div>
                      <label for="earlyShopper">Early Shopper?</label>
                      <select id="earlyShopper">
                        <option value="no" selected>No</option>
                        <option value="yes">Yes</option>
                      </select>
                    </div>
                    <div>
                      <label for="bundleType">Bundle Policy</label>
                      <select id="bundleType">
                        <option value="none" selected>No bundle</option>
                        <option value="home">Bundle with Homeowners</option>
                        <option value="renters">Bundle with Renters</option>
                      </select>
                    </div>
                  </div>

                  <div class="row" style="margin-top:12px;">
                    <div>
                      <label for="signal">Telematics / Signal Enrolled?</label>
                      <select id="signal">
                        <option value="no" selected>No</option>
                        <option value="yes">Yes</option>
                      </select>
                    </div>
                    <div>
                      <label for="discountCap">Discount Cap</label>
                      <input id="discountCap" type="number" step="0.01" min="0.50" max="1.00" value="0.65" />
                      <div class="hint">Minimum combined discount factor (0.65 ≈ max 35% off).</div>
                    </div>
                  </div>
                </div>

                <div class="actions">
                  <button type="button" class="btn" id="calculateBtn">Recalculate</button>
                  <button type="reset" class="btn secondary" id="resetBtn">Reset</button>
                </div>
                <div id="formError" class="error"></div>

                <div class="note">
                  <strong>Demo disclaimer:</strong> Simplified estimator, not a quote. Some factors (gender/credit) may be restricted by jurisdiction.
                </div>
              </form>
            </div>
          </section>

          <!-- RESULTS PANEL -->
          <aside class="panel">
            <div class="topbar">
              <div class="title">Results</div>
              <div class="small" id="calcStatus">Ready</div>
            </div>
            <div class="content">
              <div id="resultPills"></div>

              <div class="section">
                <div class="small muted">Estimated Premium</div>
                <div class="price" id="annual">$— / yr</div>
                <div class="muted">≈ <span id="monthly">$—</span> / month</div>
              </div>

              <div class="section">
                <h3>Breakdown</h3>
                <ul id="breakdown"></ul>
              </div>

              <div class="section">
                <h3>Assumptions</h3>
                <ul class="small">
                  <li>Base: $1000 per vehicle / year</li>
                  <li>Accident surcharge: $200 each (cap 5)</li>
                  <li>Vehicle & coverage apply to all vehicles</li>
                  <li>Multi-vehicle discount at 2+ vehicles</li>
                  <li>Discount stacking capped (configurable)</li>
                </ul>
              </div>
            </div>
          </aside>

        </div>
      </div>
    </div>
  </div>

<script>
  // -------------------------------
  // CONFIG (Adjust rating weights)
  // -------------------------------
  const RATE_CONFIG = {
    basePerVehicle: 1000,       // USD/year per vehicle
    accidentSurcharge: 200,    // USD per accident
    accidentCap: 5,            // max accidents counted

    // Risk factors
    ageFactor: (age) => {
      if (age < 25) return 1.50;
      if (age <= 64) return 1.00;
      return 1.20;
    },
    creditFactor: (score) => {
      if (score >= 800) return 0.90;
      if (score >= 740) return 1.00;
      if (score >= 670) return 1.10;
      if (score >= 580) return 1.25;
      return 1.50;
    },
    multiVehicleFactor: (vehicles) => {
      if (vehicles >= 3) return 0.85;
      if (vehicles === 2) return 0.90;
      return 1.00;
    },
    vehicleTypeFactor: (typeKey) => ({
      sedan: 1.00, suv: 1.10, truck: 1.15, minivan: 1.05, sports: 1.35, luxury: 1.25, ev: 1.10
    }[typeKey] ?? 1.00),
    coverageTypeFactor: (coverageKey) => ({
      liability: 0.75, standard: 1.00, enhanced: 1.20
    }[coverageKey] ?? 1.00),
    mileageFactor: (miles) => {
      if (miles <= 0) return 1.00;
      if (miles < 7500) return 0.95;
      if (miles <= 12000) return 1.00;
      if (miles <= 15000) return 1.08;
      if (miles <= 20000) return 1.15;
      return 1.25;
    },
    occupationFactor: (key) => ({
      professional: 0.98, tech: 0.97, healthcare: 1.02, education: 0.98,
      military: 0.95, service: 1.03, student: 1.05, retired: 0.97,
      government: 0.99, unemployed: 1.05, other: 1.00
    }[key] ?? 1.00),
    stateFactor: (st) => ({
      CA: 1.20, FL: 1.25, NY: 1.18, NJ: 1.15, LA: 1.22, MI: 1.20, CT: 1.12,
      TX: 1.10, GA: 1.10, IL: 1.08, CO: 1.08, AZ: 1.05, WA: 1.05, PA: 1.07,
      OH: 0.95,
      OTHER: 1.00
    }[st] ?? 1.00),

    // Gender rating controlled by UI toggle
    genderFactor: (key, enabled) => {
      if (!enabled) return 1.00;
      return ({ female: 0.98, male: 1.02, notsay: 1.00 }[key] ?? 1.00);
    },

    // Discounts
    discounts: {
      earlyShopperFactor: (yesNo) => (yesNo === 'yes' ? 0.95 : 1.00),
      bundleFactor: (bundleType) => (
        bundleType === 'home' ? 0.90 :
        bundleType === 'renters' ? 0.93 : 1.00
      ),
      signalFactor: (yesNo) => (yesNo === 'yes' ? 0.90 : 1.00)
    }
  };

  // -------------------------------
  // Helpers
  // -------------------------------
  const $ = (id) => document.getElementById(id);
  const fmt = (n) => new Intl.NumberFormat('en-US', { style:'currency', currency:'USD', maximumFractionDigits:0 }).format(n);

  function toInt(val){
    const n = Number(val);
    if (!Number.isFinite(n)) return null;
    if (!Number.isInteger(n)) return null;
    return n;
  }

  function validateInputs(data){
    const errors = [];
    if (data.age < 16 || data.age > 100) errors.push("Age must be between 16 and 100.");
    if (data.vehicles < 1 || data.vehicles > 10) errors.push("Vehicles must be between 1 and 10.");
    if (data.accidents < 0 || data.accidents > 10) errors.push("Accidents must be between 0 and 10.");
    if (data.credit < 300 || data.credit > 850) errors.push("Credit score must be between 300 and 850.");
    if (data.mileage < 0 || data.mileage > 100000) errors.push("Mileage must be between 0 and 100,000.");
    if (data.discountCap < 0.50 || data.discountCap > 1.00) errors.push("Discount cap must be between 0.50 and 1.00.");
    return errors;
  }

  function calculatePremium(data){
    const base = RATE_CONFIG.basePerVehicle * data.vehicles;

    const ageF    = RATE_CONFIG.ageFactor(data.age);
    const creditF = RATE_CONFIG.creditFactor(data.credit);
    const mvF     = RATE_CONFIG.multiVehicleFactor(data.vehicles);
    const vtF     = RATE_CONFIG.vehicleTypeFactor(data.vehicleType);
    const covF    = RATE_CONFIG.coverageTypeFactor(data.coverageType);
    const milesF  = RATE_CONFIG.mileageFactor(data.mileage);
    const occF    = RATE_CONFIG.occupationFactor(data.occupation);
    const stateF  = RATE_CONFIG.stateFactor(data.state);
    const genderF = RATE_CONFIG.genderFactor(data.gender, data.enableGenderRating);

    const riskProduct = ageF * creditF * mvF * vtF * covF * milesF * occF * stateF * genderF;

    const d = RATE_CONFIG.discounts;
    const earlyF  = d.earlyShopperFactor(data.earlyShopper);
    const bundleF = d.bundleFactor(data.bundleType);
    const signalF = d.signalFactor(data.signal);
    const discountProduct = earlyF * bundleF * signalF;

    // cap discount stacking
    const effectiveDiscount = Math.max(discountProduct, data.discountCap);
    const discountCapped = discountProduct < data.discountCap;

    const countedAccidents = Math.min(data.accidents, RATE_CONFIG.accidentCap);
    const accidentCharge = countedAccidents * RATE_CONFIG.accidentSurcharge;

    const annual = Math.round((base * riskProduct * effectiveDiscount) + accidentCharge);
    const monthly = Math.round(annual / 12);

    return {
      annual, monthly,
      parts: {
        base, ageF, creditF, mvF, vtF, covF, milesF, occF, stateF, genderF,
        earlyF, bundleF, signalF, discountProduct, effectiveDiscount, discountCapped,
        countedAccidents, accidentCharge
      }
    };
  }

  function labelForBundle(v){ return ({none:'No bundle', home:'Homeowners', renters:'Renters'}[v] ?? v); }
  function labelForCoverage(v){ return ({liability:'Liability', standard:'Standard Full', enhanced:'Enhanced Full'}[v] ?? v); }
  function labelForVehicle(v){ return ({sedan:'Sedan/Coupe', suv:'SUV/Crossover', truck:'Pickup', minivan:'Minivan', sports:'Sports', luxury:'Luxury', ev:'EV'}[v] ?? v); }
  function labelForGender(v){ return ({female:'Female', male:'Male', notsay:'Prefer not to say'}[v] ?? v); }

  function getFormData(){
    return {
      age: toInt($('age').value),
      vehicles: toInt($('vehicles').value),
      accidents: toInt($('accidents').value),
      credit: toInt($('credit').value),
      mileage: toInt($('mileage').value),

      gender: $('gender').value,
      occupation: $('occupation').value,
      state: $('state').value,
      vehicleType: $('vehicleType').value,
      coverageType: $('coverageType').value,

      earlyShopper: $('earlyShopper').value,
      bundleType: $('bundleType').value,
      signal: $('signal').value,

      discountCap: Number($('discountCap').value),
      enableGenderRating: $('enableGender').checked
    };
  }

  function updateResults(){
    $('calcStatus').textContent = "Calculating…";
    const data = getFormData();

    // handle empty numeric fields
    const numericFields = ['age','vehicles','accidents','credit','mileage'];
    for (const f of numericFields){
      if (data[f] === null){
        $('formError').textContent = "Please fill out all numeric fields with valid whole numbers.";
        $('annual').textContent = "$— / yr";
        $('monthly').textContent = "$—";
        $('breakdown').innerHTML = "";
        $('resultPills').innerHTML = "";
        $('calcStatus').textContent = "Waiting for valid inputs";
        return;
      }
    }

    const errors = validateInputs(data);
    if (errors.length){
      $('formError').textContent = errors.join(" ");
      $('annual').textContent = "$— / yr";
      $('monthly').textContent = "$—";
      $('breakdown').innerHTML = "";
      $('resultPills').innerHTML = "";
      $('calcStatus').textContent = "Fix validation errors";
      return;
    }

    $('formError').textContent = "";
    const res = calculatePremium(data);

    $('annual').textContent = `${fmt(res.annual)} / yr`;
    $('monthly').textContent = fmt(res.monthly);

    // pills
    const pills = [
      `Age: ${data.age}`,
      `Vehicles: ${data.vehicles}`,
      `Accidents: ${data.accidents}`,
      `Credit: ${data.credit}`,
      `Vehicle: ${labelForVehicle(data.vehicleType)}`,
      `Coverage: ${labelForCoverage(data.coverageType)}`,
      `Miles/yr: ${data.mileage.toLocaleString()}`,
      `Gender: ${labelForGender(data.gender)}${data.enableGenderRating ? '' : ' (ignored)'}`,
      `Occupation: ${data.occupation}`,
      `State: ${data.state}`,
      `Early shopper: ${data.earlyShopper}`,
      `Bundle: ${labelForBundle(data.bundleType)}`,
      `Telematics: ${data.signal}`
    ];
    $('resultPills').innerHTML = pills.map(p => `<span class="pill">${p}</span>`).join("");

    const b = res.parts;
    const lines = [
      `<strong>Base</strong>: ${fmt(RATE_CONFIG.basePerVehicle)} × ${data.vehicles} = ${fmt(b.base)}`,
      `Age factor: ×${b.ageF.toFixed(2)}`,
      `Credit factor: ×${b.creditF.toFixed(2)}`,
      `Multi‑vehicle factor: ×${b.mvF.toFixed(2)}`,
      `Vehicle type factor: ×${b.vtF.toFixed(2)}`,
      `Coverage factor: ×${b.covF.toFixed(2)}`,
      `Mileage factor: ×${b.milesF.toFixed(2)}`,
      `Occupation factor: ×${b.occF.toFixed(2)}`,
      `State factor: ×${b.stateF.toFixed(2)}`,
      `Gender factor: ×${b.genderF.toFixed(2)} ${data.enableGenderRating ? '' : '(disabled)'}`,
      `<div class="divider"></div>`,
      `<strong>Discounts</strong>:`,
      `Early shopper: ×${b.earlyF.toFixed(2)}`,
      `Bundle: ×${b.bundleF.toFixed(2)}`,
      `Telematics/Signal: ×${b.signalF.toFixed(2)}`,
      `Combined discounts: ×${b.discountProduct.toFixed(2)}${b.discountCapped ? ` (capped to ×${b.effectiveDiscount.toFixed(2)})` : ''}`,
      `<div class="divider"></div>`,
      `Accident surcharge: ${b.countedAccidents} × ${fmt(RATE_CONFIG.accidentSurcharge)} = ${fmt(b.accidentCharge)}`
    ];
    $('breakdown').innerHTML = lines.map(x => `<li>${x}</li>`).join("");
    $('calcStatus').textContent = "Up to date";
  }

  function attachLiveUpdates(){
    const form = $('rateForm');
    form.addEventListener('input', updateResults);
    form.addEventListener('change', updateResults);
    $('calculateBtn').addEventListener('click', updateResults);
    $('resetBtn').addEventListener('click', () => setTimeout(updateResults, 0));
    $('enableGender').addEventListener('change', updateResults);
  }

  // -------------------------------
  // Modal open/close behavior
  // -------------------------------
  const overlay = $('modalOverlay');
  const openBtn = $('openModalBtn');
  const closeBtn = $('closeModalBtn');

  let lastFocusedEl = null;

  function openModal(){
    lastFocusedEl = document.activeElement;
    overlay.classList.add('open');
    overlay.setAttribute('aria-hidden', 'false');
    document.body.style.overflow = 'hidden'; // prevent background scroll
    // focus first input in modal
    setTimeout(() => $('age').focus(), 0);
    updateResults();
  }

  function closeModal(){
    overlay.classList.remove('open');
    overlay.setAttribute('aria-hidden', 'true');
    document.body.style.overflow = '';
    if (lastFocusedEl) lastFocusedEl.focus();
  }

  openBtn.addEventListener('click', openModal);
  closeBtn.addEventListener('click', closeModal);

  // click outside modal closes it
  overlay.addEventListener('click', (e) => {
    if (e.target === overlay) closeModal();
  });

  // ESC closes it
  window.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && overlay.classList.contains('open')){
      closeModal();
    }
  });

  attachLiveUpdates();
</script>
</body>
</html>
